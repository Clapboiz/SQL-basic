-- Chay lenh tao CSDL truoc
CREATE DATABASE QUANLIGIAOVU_0208
GO

-- Refesh lai CSDL moi lam tiep cac lenh sau
USE QUANLIGIAOVU_0208
GO
-------------------------------------------------
-------------------------------------------------
-- Tao bang + khoa chinh,khoa ngoai
CREATE TABLE KHOA(
	MAKHOA	char(4),
	TENKHOA	varchar(40),
	NGTLAP	smalldatetime,
	TRGKHOA	char(4)
	CONSTRAINT PK_KHOA PRIMARY KEY(MAKHOA)
)
DROP TABLE MONHOC

CREATE TABLE MONHOC(
	MAMH	char(10),
	TENMH	varchar(40),
	TCLT	tinyint,
	TCTH	tinyint,
	MAKHOA	char(4),
	CONSTRAINT PK_MH PRIMARY KEY(MAMH)
)

CREATE TABLE DIEUKIEN(
	MAMH		char(10),
	MAMH_TRUOC	char(10),
	CONSTRAINT PK_DK PRIMARY KEY(MAMH,MAMH_TRUOC)
)

CREATE TABLE GIAOVIEN(
	MAGV		char(4),
	HOTEN		varchar(40),
	HOCVI		varchar(10),
	HOCHAM		varchar(10),
	GIOITINH	varchar(3),
	NGSINH		smalldatetime,
	NGVL		smalldatetime,
	HESO		numeric(4,2),
	MUCLUONG	money,
	MAKHOA		char(4),
	CONSTRAINT PK_GV PRIMARY KEY(MAGV)
)

CREATE TABLE LOP(
	MALOP	char(3),
	TENLOP	varchar(40),
	TRGLOP	char(5),
	SISO	tinyint,
	MAGVCN	char(4),
	CONSTRAINT PK_LOP PRIMARY KEY(MALOP)
)

CREATE TABLE HOCVIEN(
	MAHV		char(5),
	HO		varchar(40),
	TEN		varchar(10),
	NGSINH		smalldatetime,
	GIOITINH	varchar(3),
	NOISINH		varchar(40),
	MALOP		char(3),
	CONSTRAINT PK_HV PRIMARY KEY(MAHV)
)

CREATE TABLE GIANGDAY(
	MALOP	char(3),
	MAMH	char(10),
	MAGV	char(4),
	HOCKY	tinyint,
	NAM	smallint,
	TUNGAY	smalldatetime,
	DENNGAY	smalldatetime,
	CONSTRAINT PK_GD PRIMARY KEY(MALOP,MAMH)
)

CREATE TABLE KETQUATHI(
	MAHV	char(5),
	MAMH	char(10),
	LANTHI	tinyint,
	NGTHI	smalldatetime,
	DIEM	numeric(4,2),
	KQUA	varchar(10),
	CONSTRAINT PK_KQ PRIMARY KEY(MAHV,MAMH,LANTHI)
)

-------------------------------------------
-- KHOA 	
ALTER TABLE KHOA ADD CONSTRAINT FK_KHOA FOREIGN KEY(TRGKHOA) REFERENCES GIAOVIEN(MAGV)
-------------------------------------------
-- MONHOC 
--ALTER TABLE MONHOC
--DROP CONSTRAINT FK_MH
ALTER TABLE MONHOC ADD CONSTRAINT FK_MH FOREIGN KEY(MAKHOA) REFERENCES KHOA(MAKHOA)
-------------------------------------------
-- DIEUKIEN 	
ALTER TABLE DIEUKIEN ADD CONSTRAINT FK01_DK FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH)
ALTER TABLE DIEUKIEN ADD CONSTRAINT FK02_DK FOREIGN KEY(MAMH_TRUOC) REFERENCES MONHOC(MAMH)
-------------------------------------------
-- GIAOVIEN
ALTER TABLE GIAOVIEN ADD CONSTRAINT FK_GV FOREIGN KEY(MAKHOA) REFERENCES KHOA(MAKHOA)
-------------------------------------------
-- LOP
ALTER TABLE LOP ADD CONSTRAINT FK01_LOP FOREIGN KEY(TRGLOP) REFERENCES HOCVIEN(MAHV)
ALTER TABLE LOP ADD CONSTRAINT FK02_LOP FOREIGN KEY(MAGVCN) REFERENCES GIAOVIEN(MAGV)
-------------------------------------------
-- HOCVIEN
ALTER TABLE HOCVIEN ADD CONSTRAINT FK_HV FOREIGN KEY(MALOP) REFERENCES LOP(MALOP)
-------------------------------------------
-- GIANGDAY
ALTER TABLE GIANGDAY ADD CONSTRAINT FK01_GD FOREIGN KEY(MALOP) REFERENCES LOP(MALOP)
ALTER TABLE GIANGDAY ADD CONSTRAINT FK02_GD FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH)
ALTER TABLE GIANGDAY ADD CONSTRAINT FK03_GD FOREIGN KEY(MAGV) REFERENCES GIAOVIEN(MAGV)
-------------------------------------------
-- KETQUATHI
ALTER TABLE KETQUATHI ADD CONSTRAINT FK01_KQ FOREIGN KEY(MAHV) REFERENCES HOCVIEN(MAHV)
ALTER TABLE KETQUATHI ADD CONSTRAINT FK02_KQ FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH)

-------------------------------------------------
-------------------------------------------------
-- Nhap lieu
ALTER TABLE KHOA NOCHECK CONSTRAINT ALL
ALTER TABLE LOP NOCHECK CONSTRAINT ALL
ALTER TABLE MONHOC NOCHECK CONSTRAINT ALL
ALTER TABLE DIEUKIEN NOCHECK CONSTRAINT ALL
ALTER TABLE GIAOVIEN NOCHECK CONSTRAINT ALL
ALTER TABLE HOCVIEN NOCHECK CONSTRAINT ALL
ALTER TABLE GIANGDAY NOCHECK CONSTRAINT ALL
ALTER TABLE KETQUATHI NOCHECK CONSTRAINT ALL

delete from KHOA
delete from LOP
delete from MONHOC
delete from DIEUKIEN
delete from GIAOVIEN
delete from HOCVIEN
delete from GIANGDAY
delete from KETQUATHI

set dateformat dmy
-- KHOA
INSERT INTO KHOA VALUES('KHMT','Khoa hoc may tinh','06/07/2005','GV01')
INSERT INTO KHOA VALUES('HTTT','He thong thong tin','06/07/2005','GV02')
INSERT INTO KHOA VALUES('CNPM','Cong nghe phan mem','06/07/2005','GV04')
INSERT INTO KHOA VALUES('MTT','Mang va truyen thong','20/10/2005','GV03')
INSERT INTO KHOA VALUES('KTMT','Ky thuat may tinh','20/12/2005','Null')

-- LOP
INSERT INTO LOP VALUES('K11','Lop 1 khoa 1','K1108',11,'GV07')
INSERT INTO LOP VALUES('K12','Lop 2 khoa 1','K1205',12,'GV09')
INSERT INTO LOP VALUES('K13','Lop 3 khoa 1','K1305',12,'GV14')

-- MONHOC
SELECT * FROM MONHOC

INSERT INTO MONHOC VALUES('THDC','Tin hoc dai cuong',4,1,'KHMT')
INSERT INTO MONHOC VALUES('CTRR','Cau truc roi rac',5,0,'KHMT')
INSERT INTO MONHOC VALUES('CSDL','Co so du lieu',3,1,'HTTT')
INSERT INTO MONHOC VALUES('CTDLGT','Cau truc du lieu va giai thuat',3,1,'KHMT')
INSERT INTO MONHOC VALUES('PTTKTT','Phan tich thiet ke thuat toan',3,0,'KHMT')
INSERT INTO MONHOC VALUES('DHMT','Do hoa may tinh',3,1,'KHMT')
INSERT INTO MONHOC VALUES('KTMT','Kien truc may tinh',3,0,'KTMT')
INSERT INTO MONHOC VALUES('TKCSDL','Thiet ke co so du lieu',3,1,'HTTT')
INSERT INTO MONHOC VALUES('PTTKHTTT','Phan tich thiet ke he thong thong tin',4,1,'HTTT')
INSERT INTO MONHOC VALUES('HDH','He dieu hanh',4,0,'KTMT')
INSERT INTO MONHOC VALUES('NMCNPM','Nhap mon cong nghe phan mem',3,0,'CNPM')
INSERT INTO MONHOC VALUES('LTCFW','Lap trinh C for win',3,1,'CNPM')
INSERT INTO MONHOC VALUES('LTHDT','Lap trinh huong doi tuong',3,1,'CNPM')

-- DIEUKIEN
INSERT INTO DIEUKIEN VALUES('CSDL','CTRR')
INSERT INTO DIEUKIEN VALUES('CSDL','CTDLGT')
INSERT INTO DIEUKIEN VALUES('CTDLGT','THDC')
INSERT INTO DIEUKIEN VALUES('PTTKTT','THDC')
INSERT INTO DIEUKIEN VALUES('PTTKTT','CTDLGT')
INSERT INTO DIEUKIEN VALUES('DHMT','THDC')
INSERT INTO DIEUKIEN VALUES('LTHDT','THDC')
INSERT INTO DIEUKIEN VALUES('PTTKHTTT','CSDL')

-- GIANGDAY
INSERT INTO GIANGDAY VALUES('K11','THDC','GV07',1,2006,'01/02/2006','05/12/2006')
INSERT INTO GIANGDAY VALUES('K12','THDC','GV06',1,2006,'01/02/2006','05/12/2006')
INSERT INTO GIANGDAY VALUES('K13','THDC','GV15',1,2006,'01/02/2006','05/12/2006')
INSERT INTO GIANGDAY VALUES('K11','CTRR','GV02',1,2006,'01/09/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES('K12','CTRR','GV02',1,2006,'01/09/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES('K13','CTRR','GV08',1,2006,'01/09/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES('K11','CSDL','GV05',2,2006,'06/01/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES('K12','CSDL','GV09',2,2006,'06/01/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES('K13','CTDLGT','GV15',2,2006,'06/01/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES('K13','CSDL','GV05',3,2006,'08/01/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K13','DHMT','GV07',3,2006,'08/01/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K11','CTDLGT','GV15',3,2006,'08/01/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K12','CTDLGT','GV15',3,2006,'08/01/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES('K11','HDH','GV04',1,2007,'01/02/2007','18/2/2007')
INSERT INTO GIANGDAY VALUES('K12','HDH','GV04',1,2007,'01/02/2007','20/3/2007')
INSERT INTO GIANGDAY VALUES('K11','DHMT','GV07',1,2007,'18/2/2007','20/3/2007')

-- GIAOVIEN
INSERT INTO GIAOVIEN VALUES('GV01','Ho Thanh Son','PTS','GS','Nam','05/02/1950','01/11/2004',5,2250000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV02','Tran Tam Thanh','TS','PGS','Nam','17/12/1965','20/4/2004',4.5,2025000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV03','Do Nghiem Phung','TS','GS','Nu','08/01/1950','23/9/2004',4,1800000,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV04','Tran Nam Son','TS','PGS','Nam','22/2/1961','01/12/2005',4.5,2025000,'KTMT')
INSERT INTO GIAOVIEN VALUES('GV05','Mai Thanh Danh','ThS','GV','Nam','03/12/1958','01/12/2005',3,1350000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV06','Tran Doan Hung','TS','GV','Nam','03/11/1953','01/12/2005',4.5,2025000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV07','Nguyen Minh Tien','ThS','GV','Nam','23/11/1971','03/01/2005',4,1800000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV08','Le Thi Tran','KS','Null','Nu','26/3/1974','03/01/2005',1.69,760500,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV09','Nguyen To Lan','ThS','GV','Nu','31/12/1966','03/01/2005',4,1800000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV10','Le Tran Anh Loan','KS','Null','Nu','17/7/1972','03/01/2005',1.86,837000,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV11','Ho Thanh Tung','CN','GV','Nam','01/12/1980','15/5/2005',2.67,1201500,'MTT')
INSERT INTO GIAOVIEN VALUES('GV12','Tran Van Anh','CN','Null','Nu','29/3/1981','15/5/2005',1.69,760500,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV13','Nguyen Linh Dan','CN','Null','Nu','23/5/1980','15/5/2005',1.69,760500,'KTMT')
INSERT INTO GIAOVIEN VALUES('GV14','Truong Minh Chau','ThS','GV','Nu','30/11/1976','15/5/2005',3,1350000,'MTT')
INSERT INTO GIAOVIEN VALUES('GV15','Le Ha Thanh','ThS','GV','Nam','05/04/1978','15/5/2005',3,1350000,'KHMT')

-- HOCVIEN
INSERT INTO HOCVIEN VALUES('K1101','Nguyen Van','A','27/1/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN VALUES('K1102','Tran Ngoc','Han','14/3/1986','Nu','Kien Giang','K11')
INSERT INTO HOCVIEN VALUES('K1103','Ha Duy','Lap','18/4/1986','Nam','Nghe An','K11')
INSERT INTO HOCVIEN VALUES('K1104','Tran Ngoc','Linh','30/3/1986','Nu','Tay Ninh','K11')
INSERT INTO HOCVIEN VALUES('K1105','Tran Minh','Long','27/2/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN VALUES('K1106','Le Nhat','Minh','24/1/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN VALUES('K1107','Nguyen Nhu','Nhut','27/1/1986','Nam','Ha Noi','K11')
INSERT INTO HOCVIEN VALUES('K1108','Nguyen Manh','Tam','27/2/1986','Nam','Kien Giang','K11')
INSERT INTO HOCVIEN VALUES('K1109','Phan Thi Thanh','Tam','27/1/1986','Nu','Vinh Long','K11')
INSERT INTO HOCVIEN VALUES('K1110','Le Hoai','Thuong','02/05/1986','Nu','Can Tho','K11')
INSERT INTO HOCVIEN VALUES('K1111','Le Ha','Vinh','25/12/1986','Nam','Vinh Long','K11')
INSERT INTO HOCVIEN VALUES('K1201','Nguyen Van','B','02/11/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1202','Nguyen Thi Kim','Duyen','18/1/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1203','Tran Thi Kim','Duyen','17/9/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1204','Truong My','Hanh','19/5/1986','Nu','Dong Nai','K12')
INSERT INTO HOCVIEN VALUES('K1205','Nguyen Thanh','Nam','17/4/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1206','Nguyen Thi Truc','Thanh','03/04/1986','Nu','Kien Giang','K12')
INSERT INTO HOCVIEN VALUES('K1207','Tran Thi Bich','Thuy','02/08/1986','Nu','Nghe An','K12')
INSERT INTO HOCVIEN VALUES('K1208','Huynh Thi Kim','Trieu','04/08/1986','Nu','Tay Ninh','K12')
INSERT INTO HOCVIEN VALUES('K1209','Pham Thanh','Trieu','23/2/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1210','Ngo Thanh','Tuan','14/2/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1211','Do Thi','Xuan','03/09/1986','Nu','Ha Noi','K12')
INSERT INTO HOCVIEN VALUES('K1212','Le Thi Phi','Yen','03/12/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1301','Nguyen Thi Kim','Cuc','06/09/1986','Nu','Kien Giang','K13')
INSERT INTO HOCVIEN VALUES('K1302','Truong Thi My','Hien','18/3/1986','Nu','Nghe An','K13')
INSERT INTO HOCVIEN VALUES('K1303','Le Duc','Hien','21/3/1986','Nam','Tay Ninh','K13')
INSERT INTO HOCVIEN VALUES('K1304','Le Quang','Hien','18/4/1986','Nam','TpHCM','K13')
INSERT INTO HOCVIEN VALUES('K1305','Le Thi','Huong','27/3/1986','Nu','TpHCM','K13')
INSERT INTO HOCVIEN VALUES('K1306','Nguyen Thai','Huu','30/3/1986','Nam','Ha Noi','K13')
INSERT INTO HOCVIEN VALUES('K1307','Tran Minh','Man','28/5/1986','Nam','TpHCM','K13')
INSERT INTO HOCVIEN VALUES('K1308','Nguyen Hieu','Nghia','04/08/1986','Nam','Kien Giang','K13')
INSERT INTO HOCVIEN VALUES('K1309','Nguyen Trung','Nghia','18/1/1987','Nam','Nghe An','K13')
INSERT INTO HOCVIEN VALUES('K1310','Tran Thi Hong','Tham','22/4/1986','Nu','Tay Ninh','K13')
INSERT INTO HOCVIEN VALUES('K1311','Tran Minh','Thuc','04/04/1986','Nam','TpHCM','K13')
INSERT INTO HOCVIEN VALUES('K1312','Nguyen Thi Kim','Yen','09/07/1986','Nu','TpHCM','K13')

-- KETQUATHI
INSERT INTO KETQUATHI VALUES('K1101','CSDL',1,'20/7/2006',10,'Dat')
INSERT INTO KETQUATHI VALUES('K1101','CTDLGT',1,'28/12/2006',9,'Dat')
INSERT INTO KETQUATHI VALUES('K1101','THDC',1,'20/5/2006',9,'Dat')
INSERT INTO KETQUATHI VALUES('K1101','CTRR',1,'13/5/2006',9.5,'Dat')
INSERT INTO KETQUATHI VALUES('K1102','CSDL',1,'20/7/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1102','CSDL',2,'27/7/2006',4.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1102','CSDL',3,'08/10/2006',4.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1102','CTDLGT',1,'28/12/2006',4.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1102','CTDLGT',2,'01/05/2007',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1102','CTDLGT',3,'15/1/2007',6,'Dat')
INSERT INTO KETQUATHI VALUES('K1102','THDC',1,'20/5/2006',5,'Dat')
INSERT INTO KETQUATHI VALUES('K1102','CTRR',1,'13/5/2006',7,'Dat')
INSERT INTO KETQUATHI VALUES('K1103','CSDL',1,'20/7/2006',3.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1103','CSDL',2,'27/7/2006',8.25,'Dat')
INSERT INTO KETQUATHI VALUES('K1103','CTDLGT',1,'28/12/2006',7,'Dat')
INSERT INTO KETQUATHI VALUES('K1103','THDC',1,'20/5/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES('K1103','CTRR',1,'13/5/2006',6.5,'Dat')
INSERT INTO KETQUATHI VALUES('K1104','CSDL',1,'20/7/2006',3.75,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1104','CTDLGT',1,'28/12/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1104','THDC',1,'20/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1104','CTRR',1,'13/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1104','CTRR',2,'20/5/2006',3.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1104','CTRR',3,'30/6/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1201','CSDL',1,'20/7/2006',6,'Dat')
INSERT INTO KETQUATHI VALUES('K1201','CTDLGT',1,'28/12/2006',5,'Dat')
INSERT INTO KETQUATHI VALUES('K1201','THDC',1,'20/5/2006',8.5,'Dat')
INSERT INTO KETQUATHI VALUES('K1201','CTRR',1,'13/5/2006',9,'Dat')
INSERT INTO KETQUATHI VALUES('K1202','CSDL',1,'20/7/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES('K1202','CTDLGT',1,'28/12/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1202','CTDLGT',2,'01/05/2007',5,'Dat')
INSERT INTO KETQUATHI VALUES('K1202','THDC',1,'20/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1202','THDC',2,'27/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1202','CTRR',1,'13/5/2006',3,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1202','CTRR',2,'20/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1202','CTRR',3,'30/6/2006',6.25,'Dat')
INSERT INTO KETQUATHI VALUES('K1203','CSDL',1,'20/7/2006',9.25,'Dat')
INSERT INTO KETQUATHI VALUES('K1203','CTDLGT',1,'28/12/2006',9.5,'Dat')
INSERT INTO KETQUATHI VALUES('K1203','THDC',1,'20/5/2006',10,'Dat')
INSERT INTO KETQUATHI VALUES('K1203','CTRR',1,'13/5/2006',10,'Dat')
INSERT INTO KETQUATHI VALUES('K1204','CSDL',1,'20/7/2006',8.5,'Dat')
INSERT INTO KETQUATHI VALUES('K1204','CTDLGT',1,'28/12/2006',6.75,'Dat')
INSERT INTO KETQUATHI VALUES('K1204','THDC',1,'20/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1204','CTRR',1,'13/5/2006',6,'Dat')
INSERT INTO KETQUATHI VALUES('K1301','CSDL',1,'20/12/2006',4.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1301','CTDLGT',1,'25/7/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES('K1301','THDC',1,'20/5/2006',7.75,'Dat')
INSERT INTO KETQUATHI VALUES('K1301','CTRR',1,'13/5/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES('K1302','CSDL',1,'20/12/2006',6.75,'Dat')
INSERT INTO KETQUATHI VALUES('K1302','CTDLGT',1,'25/7/2006',5,'Dat')
INSERT INTO KETQUATHI VALUES('K1302','THDC',1,'20/5/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES('K1302','CTRR',1,'13/5/2006',8.5,'Dat')
INSERT INTO KETQUATHI VALUES('K1303','CSDL',1,'20/12/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1303','CTDLGT',1,'25/7/2006',4.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1303','CTDLGT',2,'08/07/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1303','CTDLGT',3,'15/8/2006',4.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1303','THDC',1,'20/5/2006',4.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1303','CTRR',1,'13/5/2006',3.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES('K1303','CTRR',2,'20/5/2006',5,'Dat')
INSERT INTO KETQUATHI VALUES('K1304','CSDL',1,'20/12/2006',7.75,'Dat')
INSERT INTO KETQUATHI VALUES('K1304','CTDLGT',1,'25/7/2006',9.75,'Dat')
INSERT INTO KETQUATHI VALUES('K1304','THDC',1,'20/5/2006',5.5,'Dat')
INSERT INTO KETQUATHI VALUES('K1304','CTRR',1,'13/5/2006',5,'Dat')
INSERT INTO KETQUATHI VALUES('K1305','CSDL',1,'20/12/2006',9.25,'Dat')
INSERT INTO KETQUATHI VALUES('K1305','CTDLGT',1,'25/7/2006',10,'Dat')
INSERT INTO KETQUATHI VALUES('K1305','THDC',1,'20/5/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES('K1305','CTRR',1,'13/5/2006',10,'Dat')

-----------------
--					PHAN 1
--1
ALTER TABLE HOCVIEN 
ADD GHICHU VARCHAR(100),
	DIEMTB INT,
	XEPLOAI VARCHAR(10)

--2
CREATE TRIGGER INSERT_UPDATE_HV
ON HOCVIEN
FOR INSERT, UPDATE
AS
	DECLARE @MALOP CHAR(3),
		@SISO TINYINT,
		@MAHV CHAR(5)

	SELECT @MAHV=MAHV, @MALOP=MALOP
	FROM INSERTED

	SELECT @SISO = SISO
	FROM LOP 
	WHERE LOP.MALOP	= @MALOP

	IF LEFT(@MAHV,3) <> @MALOP
	BEGIN
	PRINT('3 KI TU DAU CUA HV KHONG PHAI LA CUA MALOP')
	ROLLBACK TRAN
	END

	-- IF CAST (... AS INT) LÀ CHUY?N SANG KI?U D? LI?U INT 
	ELSE IF CAST(RIGHT(@MAHV, 2) AS INT) NOT BETWEEN 1 AND @SISO
	BEGIN
	PRINT ('2 KY TU CUOI K PHAI CUA STT')
	ROLLBACK TRAN 
	END
--3
ALTER TABLE HOCVIEN
ADD CONSTRAINT CHECK_GTHV
CHECK (GIOITINH IN ('Nam', 'Nu'))

ALTER TABLE GIAOVIEN
ADD CONSTRAINT CHECK_GTGV 
CHECK (GIOITINH IN ('Nam', 'Nu'))

--4

ALTER TABLE KETQUATHI
DROP CONSTRAINT CHEK_DIEM
ADD CONSTRAINT CHEK_DIEM CHECK 
(
	DIEM BETWEEN 0 AND 10
	AND DIEM LIKE '%.__'
)
--SELECT*FROM KETQUATHI
--insert into KETQUATHI

ALTER TABLE KETQUATHI ADD CONSTRAINT CHECK_DIEM CHECK 
(
	DIEM BETWEEN 0 AND 10
	AND RIGHT(CAST(DIEM AS VARCHAR), 3) LIKE '.__'
)

--5
ALTER TABLE KETQUATHI
ADD CONSTRAINT CHECK_KQT
CHECK(
	(KQUA = 'DAT' AND DIEM BETWEEN 5 AND 10)
	OR KQUA='KHONG DAT' AND DIEM<5
)

--6
ALTER TABLE KETQUATHI
ADD CONSTRAINT CHECK_LANTHI
CHECK(LANTHI BETWEEN 1 AND 3)

--7
ALTER TABLE GIANGDAY
ADD CONSTRAINT CHECK_HK
CHECK(HOCKY BETWEEN 1 AND 3)

--8
ALTER TABLE GIAOVIEN
ADD CONSTRAINT CHECK_HOCVI
CHECK(HOCVI IN('CN', 'KS', 'Ths', 'TS', 'PTS'))

--9 
CREATE TRIGGER UP_LOPTRG
ON LOP
FOR UPDATE
AS
	DECLARE @TRGLOP CHAR(5), @MAHV CHAR(5)

	SELECT @TRGLOP = @TRGLOP FROM inserted
	SELECT @MAHV = MAHV FROM inserted, HOCVIEN

	WHERE HOCVIEN.MAHV = inserted.TRGLOP

UPDATE LOP
SET TRGLOP = 'K1205'
WHERE MALOP = 'K12'

CREATE TRIGGER trg_ins_udt_LopTruong ON LOP
FOR INSERT, UPDATE
AS
BEGIN
	IF NOT EXISTS (SELECT * FROM INSERTED I, HOCVIEN HV
	WHERE I.TRGLOP = HV.MAHV AND I.MALOP = HV.MALOP)
	BEGIN
		PRINT 'Error: Lop truong cua mot lop phai la hoc vien cua lop do'
		ROLLBACK TRANSACTION
	END
END

CREATE TRIGGER trg_del_HOCVIEN ON HOCVIEN
FOR DELETE
AS
BEGIN
	IF EXISTS (SELECT * FROM DELETED D, INSERTED I, LOP L 
	WHERE D.MAHV = L.TRGLOP AND D.MALOP = L.MALOP)
	BEGIN
		PRINT 'Error: Hoc vien hien tai dang la truong lop'
		ROLLBACK TRANSACTION
	END
END

--10
DROP TRIGGER IN_UP_TRGKH
CREATE TRIGGER IN_UP_TRGKH
ON KHOA
FOR INSERT, UPDATE
AS
BEGIN	
		IF NOT EXISTS(
		SELECT * FROM INSERTED, GIAOVIEN
		WHERE inserted.TRGKHOA = GIAOVIEN.MAGV
		AND inserted.MAKHOA=GIAOVIEN.MAKHOA
		AND HOCVI IN ('TS','PTS'))
			BEGIN
				PRINT 'Error: Truong khoa khong phai giao vien cua khoa do'
				ROLLBACK TRANSACTION
			END
END

CREATE TRIGGER DEL_GV
ON GIAOVIEN	
FOR DELETE
AS
BEGIN	
		IF EXISTS(
		SELECT * FROM deleted, KHOA
		WHERE deleted.MAGV = KHOA.TRGKHOA
		AND deleted.MAKHOA = KHOA.MAKHOA
		AND HOCVI IN ('TS','PTS'))
			BEGIN
				PRINT 'Truong khoa la giao vien cua khoa do'
				ROLLBACK TRANSACTION
			END
END
	
--11 
ALTER TABLE HOCVIEN 
ADD CONSTRAINT CH_TUOI CHECK(YEAR(GETDATE()) - YEAR(NGSINH) >= 18)

--12
ALTER TABLE GIANGDAY
ADD CONSTRAINT CHECK_GD CHECK(TUNGAY<DENNGAY)

--13
ALTER TABLE GIAOVIEN
ADD CONSTRAINT CHECK_TUOI_GV
CHECK((YEAR(NGVL)-YEAR(NGSINH))>22)

--14
ALTER TABLE MONHOC
DROP CONSTRAINT CHECK_TC


ALTER TABLE MONHOC WITH NOCHECK
ADD CONSTRAINT CHECK_TC
CHECK(ABS((TCLT-TCTH))<=3)

UPDATE MONHOC
SET TCLT = 5, TCTH  = 0
WHERE MAMH = 'CTRR'

--15

--16

--II
--1
UPDATE GIAOVIEN
SET HESO=HESO+0.2
WHERE MAGV IN(SELECT TRGKHOA FROM KHOA)

--2    HMMM
--UPDATE HOCVIEN
--SET DIEMTB = (
--	SELECT AVG(DIEM)
--	FROM KETQUATHI
--	WHERE LANTHI = (SELECT MAX(LANTHI) FROM KETQUATHI
--		WHERE MAHV= KETQUATHI.MAHV 
--		GROUP BY MAHV)
--	GROUP BY MaHV
--	HAVING MaHV = HOCVIEN.MaHV
--)
UPDATE HocVien
SET DiemTB =
(
	SELECT AVG(Diem)
	FROM KetQuaThi
	WHERE LanThi = (SELECT MAX(LanThi) FROM KetQuaThi  
	WHERE MaHV = HOCVIEN.MaHV GROUP BY MaHV)
	GROUP BY MaHV
	HAVING HOCVIEN.MAHV=KETQUATHI.MAHV
)

--3
UPDATE HOCVIEN
SET GHICHU = 'CAM THI'
WHERE MAHV IN (
	SELECT MAHV
	FROM KETQUATHI
	WHERE LANTHI = 3 AND DIEM <5
)

--4 
UPDATE HOCVIEN
SET XEPLOAI =
(
	CASE 
		WHEN DIEMTB >= 9 THEN 'XS'
		WHEN DIEMTB >= 8 AND DIEMTB < 9 THEN 'G'
		WHEN DIEMTB >= 6.5 AND DIEMTB < 8 THEN 'K'
		WHEN DIEMTB >= 5 AND DIEMTB < 6.5 THEN 'TB'
		WHEN DIEMTB < 5 THEN 'Y'
	END
)

--III
--1
SELECT MAHV, HO, TEN, NGSINH, HOCVIEN.MALOP
FROM HOCVIEN, LOP
WHERE HOCVIEN.MAHV = LOP.TRGLOP

--2
SELECT HOCVIEN.MAHV, HO, TEN, LANTHI, DIEM
FROM HOCVIEN, KETQUATHI
WHERE MAMH='CTRR' AND MALOP = 'K12'
AND HOCVIEN.MAHV= KETQUATHI.MAHV
ORDER BY TEN, HO

--3
SELECT HOCVIEN.MAHV, HO, TEN, MAMH
FROM HOCVIEN, KETQUATHI
WHERE LANTHI=1 AND KETQUATHI.MAHV=HOCVIEN.MAHV AND KQUA='DAT'
ORDER BY HO, TEN

--4
SELECT HOCVIEN.MAHV, HO, TEN
FROM KETQUATHI, HOCVIEN
WHERE LANTHI='1' AND MALOP = 'K11' AND MAMH = 'CTRR' AND KQUA = 'KHONG DAT'
AND HOCVIEN.MAHV = KETQUATHI.MAHV

--5
SELECT HOCVIEN.MAHV, HO, TEN
FROM KETQUATHI, HOCVIEN
WHERE MALOP LIKE 'K%' AND MAMH='CTRR'
AND HOCVIEN.MAHV = KETQUATHI.MAHV
AND NOT EXISTS(
	SELECT * FROM KETQUATHI
	WHERE KQUA = 'DAT'
	AND MAMH='CTRR'
	AND MAHV=HOCVIEN.MAHV
	)

SELECT DISTINCT
	HocVien.MaHV, (Ho+' '+Ten) HoTen
FROM
	HocVien, KetQuaThi
WHERE
	HocVien.MaHV = KetQuaThi.MaHV
	AND MaLop like 'K%'
	AND MaMH = 'CTRR'
	AND NOT EXISTS
		(SELECT * FROM KetQuaThi 
		WHERE 
			KQua = 'Dat' 
			AND MaMH = 'CTRR' 
			AND MaHV = HocVien.MaHV)
--6Tìm tên nh?ng môn h?c mà giáo viên có tên “Tran Tam Thanh” d?y trong h?c k? 1 n?m 2006.
SELECT DISTINCT TENMH
FROM GIANGDAY, GIAOVIEN, MONHOC
WHERE HOTEN = 'TRAN TAM THANH'
AND HOCKY = 1  AND NAM = 2006
AND GIANGDAY.MAGV = GIAOVIEN.MAGV
AND MONHOC.MAMH = GIANGDAY.MAMH

--7 Tìm nh?ng môn h?c (mã môn h?c, tên môn h?c) mà giáo viên
--ch? nhi?m l?p “K11” d?y trong h?c k? 1 n?m 2006
SELECT GIANGDAY.MAMH, TENMH
FROM MONHOC , GIANGDAY, LOP
WHERE
	GIANGDAY.MALOP = 'K11'
	AND HOCKY = 1 AND NAM = 2006
	AND MONHOC.MAMH = GIANGDAY.MAMH
	AND LOP.MAGVCN = GIANGDAY.MAGV

--8 Tìm h? tên l?p tr??ng c?a các l?p mà giáo viên có 
--tên “Nguyen To Lan” d?y môn “Co So Du Lieu”
SELECT HO, TEN 
FROM HOCVIEN, GIAOVIEN, GIANGDAY, MONHOC, LOP
WHERE 
	GIAOVIEN.HOTEN = 'NGUYEN TO LAN'
	AND TENMH = 'CO SO DU LIEU'
	AND HOCVIEN.MAHV = LOP.TRGLOP
	AND GIANGDAY.MAMH = MONHOC.MAMH
	AND GIANGDAY.MAGV = GIAOVIEN.MAGV
	AND GiangDay.MaLop = Lop.MaLop

--9 In ra danh sách nh?ng môn h?c (mã môn h?c, tên môn h?c) 
--ph?i h?c li?n tr??c môn “Co So Du Lieu”
SELECT MONHOCTRUOC.MAMH, MONHOCTRUOC.TENMH
FROM MONHOC, DIEUKIEN, MONHOC AS MONHOCTRUOC
WHERE MONHOC.MAMH = DIEUKIEN.MAMH
AND MONHOCTRUOC.MAMH = DIEUKIEN.MAMH_TRUOC
AND MONHOC.TENMH = 'CO SO DU LIEU'

--10 Môn “Cau Truc Roi Rac” là môn b?t bu?c
--ph?i h?c li?n tr??c nh?ng môn h?c (mã môn h?c, tên môn h?c) nào
SELECT MONHOC.MAMH, MONHOC.TENMH
FROM MONHOC, DIEUKIEN, MONHOC AS MONHOCTRUOC
WHERE 
	MONHOC.MAMH = DIEUKIEN.MAMH
	AND MONHOCTRUOC.MAMH = DIEUKIEN.MAMH_TRUOC
	AND MONHOCTRUOC.TENMH = 'CAU TRUC ROI RAC'

--11 Tìm h? tên giáo viên d?y môn CTRR 
--cho c? hai l?p “K11” và “K12” trong cùng h?c k? 1 n?m 2006.

SELECT HOTEN
FROM GIAOVIEN , GIANGDAY
WHERE MALOP = 'K11'
AND HOCKY = 1 AND NAM = 2006
AND GIAOVIEN.MAGV = GIANGDAY.MAGV
INTERSECT (
	SELECT HOTEN
	FROM GIAOVIEN , GIANGDAY
	WHERE MALOP = 'K12'
	AND HOCKY = 1 AND NAM = 2006
	AND GIAOVIEN.MAGV = GIANGDAY.MAGV)

--12 Tìm nh?ng h?c viên (mã h?c viên, h? tên) 
--thi không ??t môn CSDL ? l?n thi th? 1 nh?ng ch?a thi l?i môn này
SELECT KETQUATHI.MAHV, HO, TEN
FROM HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND LANTHI = 1 AND KQUA = 'KHONG DAT' AND MAMH = 'CSDL'
	AND NOT EXISTS (
	SELECT * FROM KETQUATHI
	WHERE LANTHI >1 AND KETQUATHI.MAHV = HOCVIEN.MAHV
	)

--13 Tìm giáo viên (mã giáo viên, h? tên) không ???c phân
--công gi?ng d?y b?t k? môn h?c nào
--C1
SELECT MaGV, HoTen
FROM GiaoVien
WHERE NOT EXISTS (
	SELECT * FROM GIANGDAY
	WHERE GIANGDAY.MAGV = GIAOVIEN.MAGV
)
--C2
SELECT MaGV, HoTen
FROM GiaoVien
WHERE MaGV NOT IN (SELECT MaGV FROM GiangDay)

--14 Tìm giáo viên (mã giáo viên, h? tên) không ???c phân 
--công gi?ng d?y b?t k? môn h?c nào thu?c khoa giáo viên ?ó ph? trách
SELECT MaGV, HoTen
FROM GiaoVien
WHERE NOT EXISTS
(
	SELECT *
	FROM MonHoc
	WHERE MonHoc.MaKhoa = GiaoVien.MaKhoa
	AND NOT EXISTS
	(
		SELECT *
		FROM GiangDay
		WHERE GiangDay.MaMH = MonHoc.MaMH
		AND GiangDay.MaGV = GiaoVien.MaGV
	)
)

--15 Tìm h? tên các h?c viên thu?c l?p “K11” thi m?t môn b?t k? 
--quá 3 l?n v?n “Khong dat” ho?c thi l?n th? 2 môn CTRR ???c 5 ?i?m
SELECT HO, TEN
FROM HOCVIEN, KETQUATHI
WHERE MALOP = 'K11'
AND MAMH = 'CTRR'
AND LANTHI =2 AND DIEM = 5
AND HOCVIEN.MAHV = KETQUATHI.MAHV
OR HOCVIEN.MAHV IN (
	SELECT MAHV
	FROM KETQUATHI
	WHERE KQUA = 'KHONG DAT'
	GROUP BY MAHV, MAMH
	HAVING COUNT(MAMH)>3
)

--16 Tìm h? tên giáo viên d?y môn CTRR cho
--ít nh?t hai l?p trong cùng m?t h?c k? c?a m?t n?m h?c
SELECT HOTEN
FROM GIAOVIEN, GIANGDAY
WHERE GIAOVIEN.MAGV = GIANGDAY.MAGV
	AND MAMH = 'CTRR'
GROUP BY GIANGDAY.MAGV, HOTEN, HOCKY
HAVING COUNT(*) >=2

--17 Danh sách h?c viên và
--?i?m thi môn CSDL (ch? l?y ?i?m c?a l?n thi sau cùng)
SELECT
	HocVien.*, Diem AS '?i?m thi CSDL sau cùng'
FROM
	HocVien, KetQuaThi
WHERE
	HocVien.MaHV = KetQuaThi.MaHV
	AND MaMH = 'CSDL'
	AND LanThi = 
	(
		SELECT MAX(LanThi) 
		FROM KetQuaThi 
		WHERE MaMH = 'CSDL' AND KetQuaThi.MaHV = HocVien.MaHV 
		GROUP BY MaHV
	)
--18 Danh sách h?c viên và ?i?m thi môn
--“Co So Du Lieu” (ch? l?y ?i?m cao nh?t c?a các l?n thi)
SELECT
	HocVien.*, Diem AS '?i?m thi CSDL cao nh?t'
FROM
	HocVien, KetQuaThi, MonHoc
WHERE
	HocVien.MaHV = KetQuaThi.MaHV
	AND KetQuaThi.MaMH = MonHoc.MaMH
	AND TenMH = 'Co So Du Lieu'
	AND Diem = 
	(
		SELECT MAX(Diem) 
		FROM KetQuaThi, MonHoc
		WHERE
			KetQuaThi.MaMH = MonHoc.MaMH
			AND MaHV = HocVien.MaHV
			AND TenMH = 'Co So Du Lieu'
		GROUP BY MaHV
	)

--19 Khoa nào (mã khoa, tên khoa) ???c thành l?p s?m nh?t
SELECT MAKHOA, TENKHOA
FROM KHOA
WHERE
	NGTLAP = (SELECT MIN(NGTLAP)
				FROM KHOA)

--20 Có bao nhiêu giáo viên có h?c hàm là “GS” ho?c “PGS”
SELECT COUNT(MAGV) AS SOGV
FROM GIAOVIEN
WHERE HOCHAM = 'GS' OR HOCHAM = 'PGS'

--21Th?ng kê có bao nhiêu giáo viên có h?c v? là 
--“CN”, “KS”, “Ths”, “TS”, “PTS” trong m?i khoa
SELECT MAKHOA, HOCVI, COUNT(*) 'SO GIAO VIEN'
FROM GIAOVIEN
WHERE HOCVI IN('CN', 'KS', 'THS', 'TS', 'PTS')
GROUP BY MAKHOA, HOCVI
ORDER BY MAKHOA

--22 M?i môn h?c th?ng kê s? l??ng h?c 
--viên theo k?t qu? (??t và không ??t). 
SELECT MAMH, KQUA, COUNT(*) SOSV
FROM KETQUATHI
GROUP BY MAMH, KQUA
ORDER BY MAMH

--23 Tìm giáo viên (mã giáo viên, h? tên) là giáoviên ch?
--nhi?m c?a m?t l?p, ??ng th?i d?y cho l?p ?ó ít nh?t m?t môn h?c. 
SELECT GIAOVIEN.MAGV, HOTEN 
FROM GIAOVIEN, GIANGDAY, LOP
WHERE GIAOVIEN.MAGV = LOP.MAGVCN
	AND GIANGDAY.MALOP = LOP.MALOP
	AND GIANGDAY.MAGV = GIAOVIEN.MAGV

--24 Tìm h? tên l?p tr??ng c?a l?p có s? s? cao nh?t
SELECT HO, TEN 
FROM LOP, HOCVIEN
WHERE SISO=(SELECT MAX(SISO) FROM LOP)
AND LOP.TRGLOP = HOCVIEN.MAHV

--25 Tìm h? tên nh?ng LOPTRG thi không ??t
--quá 3 môn (m?i môn ??u thi không ??t ? t?t c? các l?n thi)
SELECT HO, TEN
FROM LOP, HOCVIEN, KETQUATHI
WHERE KQUA = 'KHONG DAT' 
	AND LOP.TRGLOP = HOCVIEN.MAHV
	AND KETQUATHI.MAHV = HOCVIEN.MAHV
	GROUP BY TRGLOP, HO, TEN
	HAVING COUNT(*)>3

--26 Tìm h?c viên (mã h?c viên, h? tên)
--có s? môn ??t ?i?m 9,10 nhi?u nh?t. 
SELECT TOP 1 WITH TIES
HOCVIEN.MAHV, HO, TEN
FROM HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND DIEM>=9
GROUP BY HOCVIEN.MAHV, HO, TEN
ORDER BY COUNT(*) DESC

--C2
SELECT HOCVIEN.MAHV, HO, TEN
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
	AND DIEM>= 9
GROUP BY
	HOCVIEN.MAHV, HO, TEN
HAVING	COUNT(*) >= ALL(
		SELECT COUNT(*) FROM KETQUATHI
		WHERE DIEM >=9 
		GROUP BY MAHV
	)

--27 Trong t?ng l?p, tìm h?c viên (mã h?c viên, h? tên) 
--có s? môn ??t ?i?m 9,10 nhi?u nh?t.
SELECT
	MaLop, MaHV, HoTen
FROM
(
	SELECT
		MaLop, HocVien.MaHV, (Ho+' '+Ten) HoTen, COUNT(*) SoLuongDiem, 
		RANK() OVER (PARTITION BY MaLop 
		ORDER BY COUNT(*) DESC) AS XepHang
	FROM
		HocVien, KetQuaThi
	WHERE
		HocVien.MaHV = KetQuaThi.MaHV
		AND Diem >= 9
	GROUP BY
		MaLop, HocVien.MaHV, Ho, Ten
) AS A
WHERE
	A.XepHang = 1

--28 Trong t?ng h?c k? c?a t?ng n?m, m?i giáo viên phân 
--công d?y bao nhiêu môn h?c, bao nhiêu l?p.
SELECT MAGV, COUNT(MAMH) SOMH, COUNT(MALOP) SOLOP
FROM GIANGDAY
GROUP BY MAGV

--29Trong t?ng h?c k? c?a t?ng n?m, tìm giáo viên 
--(mã giáo viên, h? tên) gi?ng d?y nhi?u nh?t. 
SELECT HocKy, Nam, A.MaGV, HoTen
FROM GiaoVien,
(
	SELECT 
		HocKy, Nam, MaGV, RANK() OVER (PARTITION BY HocKy, Nam ORDER BY COUNT(*) DESC) AS XepHang
	FROM GiangDay
	GROUP BY HocKy, Nam, MaGV
) AS A
WHERE
	A.MAGV = GiaoVien.MAGV
	AND XepHang = 1
ORDER BY
	Nam, HocKy

--30 Tìm môn h?c (mã môn h?c, tên môn h?c) có 
--nhi?u h?c viên thi không ??t (? l?n thi th? 1) nh?t.
-- Cách 1:
SELECT TOP 1 WITH TIES
	MonHoc.MaMH, TenMH
FROM
	MonHoc, KetQuaThi
WHERE
	MonHoc.MaMH = KetQuaThi.MaMH
	AND LanThi = 1
	AND KQua = 'Khong Dat'
GROUP BY
	MonHoc.MaMH, TenMH
ORDER BY
	COUNT(*) DESC

-- Cách 2:
SELECT
	MonHoc.MaMH, TenMH
FROM
	MonHoc, KetQuaThi
WHERE
	MonHoc.MaMH = KetQuaThi.MaMH
	AND LanThi = 1
	AND KQua = 'Khong Dat'
GROUP BY 
	MonHoc.MaMH, TenMH
HAVING
	COUNT(*) >= ALL (SELECT COUNT(*) FROM KetQuaThi 
	WHERE LanThi = 1 AND KQua = 'Khong Dat' GROUP BY MAMH)

--31 Tìm h?c viên (mã h?c viên, h? tên) 
--thi môn nào c?ng ??t (ch? xét l?n thi th? 1)
SELECT DISTINCT
	HocVien.MaHV, (Ho+' '+Ten) HoTen
FROM
	HocVien, KetQuaThi
WHERE
	HocVien.MaHV = KetQuaThi.MaHV
	AND NOT EXISTS
	(
		SELECT *
		FROM KetQuaThi
		WHERE LanThi = 1
		AND KQua = 'Khong Dat'
		AND MaHV = HocVien.MaHV
	)

--32Tìm h?c viên (mã h?c viên, h? tên) thi 
--môn nào c?ng ??t (ch? xét l?n thi sau cùng).
SELECT DISTINCT
	HocVien.MaHV, (Ho+' '+Ten) HoTen
FROM
	HocVien, KetQuaThi
WHERE
	HocVien.MaHV = KetQuaThi.MaHV
	AND NOT EXISTS
	(
		SELECT *
		FROM KetQuaThi
		WHERE LanThi = (SELECT MAX(LanThi) FROM KetQuaThi WHERE MaHV = HocVien.MaHV GROUP BY MaHV)
		AND KQua = 'Khong Dat'
		AND MaHV = HocVien.MaHV
	)

--33 Tìm h?c viên (mã h?c viên, h? tên) ?ã thi 
--t?t c? các môn ??u ??t (ch? xét l?n thi th? 1)
SELECT MaHV, (Ho+' '+Ten) HoTen
FROM HocVien
WHERE NOT EXISTS
(
	SELECT *
	FROM MonHoc
	WHERE NOT EXISTS
	(
		SELECT *
		FROM KetQuaThi
		WHERE
			KetQuaThi.MaMH = MonHoc.MaMH
			AND KetQuaThi.MaHV = HocVien.MaHV
			AND LanThi = 1 AND KQua = 'Dat'
	)
)

--35 Tìm h?c viên (mã h?c viên, h? tên) có ?i?m thi cao nh?t trong t?ng môn (l?y ?i?m ? l?n thi sau cùng). 
SELECT MaMH, MaHV, HoTen
FROM
(
	SELECT
		MaMH, HocVien.MaHV, (Ho+' '+Ten) HoTen, 
		RANK() OVER (PARTITION BY MaMH ORDER BY MAX(Diem) DESC) AS XepHang
	FROM
		HocVien, KetQuaThi
	WHERE
		HocVien.MaHV = KetQuaThi.MaHV
		AND LanThi = (SELECT MAX(LanThi) FROM KetQuaThi 
		WHERE MaHV = HocVien.MaHV GROUP BY MaHV)
	GROUP BY
		MaMH, HocVien.MaHV, Ho, Ten
) AS A
WHERE XepHang = 1