create database ql_phuongtien
--Câu 1: Tạo các Quan hệ kèm khóa chính với dữ liệu được mô tả
drop database ql_phuongtien
CREATE TABLE XETAI(
	MAXE CHAR(10),
	MALX CHAR(4),
	NGMUA SMALLDATETIME,
	SOKM INT,
	PRIMARY KEY (MAXE)
);
CREATE TABLE LOAIXE(
	MALX CHAR(4),
	TENLX NVARCHAR(20),
	NHASX NVARCHAR(20),
	TAITRONG INT,
	NIENHAN INT,
	PRIMARY KEY (MALX)
);
CREATE TABLE TAIXE (
	MATX CHAR(4),
	HOTEN NVARCHAR (50),
	GTINH NVARCHAR(3),
	NGAYVL SMALLDATETIME,
	PRIMARY KEY (MATX)
);
CREATE TABLE BANGLAI(
	MABL CHAR(4),
	MATX CHAR(4),
	NGCAP SMALLDATETIME,
	LOAI CHAR(2)
	PRIMARY KEY (MABL)
);

CREATE TABLE VANCHUYEN(
	MAVC CHAR(4),
	MATX CHAR(4),
	MAXE CHAR(10),
	KLUONG INT,
	QDUONG INT,
	NGVC SMALLDATETIME
	PRIMARY KEY (MAVC)
);
--Câu 2: Tạo các ràng buộc khóa Ngoại

--Tạo ràng Buộc khóa ngoại cho Quan hệ XETAI
ALTER TABLE XETAI
ADD CONSTRAINT fk_xt_lx FOREIGN KEY  (MALX) REFERENCES LOAIXE(MALX)
--Tạo ràng Buộc khóa ngoại cho Quan hệ BANGLAI
ALTER TABLE BANGLAI
ADD CONSTRAINT fk_bl_tx FOREIGN KEY  (MATX) REFERENCES TAIXE(MATX)
--Tạo ràng Buộc khóa ngoại cho Quan hệ VANCHUYEN
ALTER TABLE VANCHUYEN
ADD CONSTRAINT fk_vc_tx FOREIGN KEY  (MATX) REFERENCES TAIXE(MATX)
ALTER TABLE VANCHUYEN
ADD CONSTRAINT fk_vc_xt FOREIGN KEY  (MAXE) REFERENCES XETAI(MAXE)

--Câu 3: Mỗi quan hệ hãy tạo thêm ràng buộc
ALTER TABLE XETAI 
ADD CONSTRAINT ch_xt CHECK(SOKM >0)
ALTER TABLE LOAIXE
ADD CONSTRAINT ch_lx CHECK(TAITRONG >0)
ALTER TABLE TAIXE
ADD CONSTRAINT ch_tx CHECK(GTINH IN (N'Nam', N'Nữ'))
ALTER TABLE VANCHUYEN
ADD CONSTRAINT ch_vc CHECK(KLUONG >0 AND QDUONG >0)
--Câu 4: Cập nhật dữ liệu

INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X002', N'Trường Phát', N'Việt Nam', 8, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X004', N'Hoàng Long', N'Thái Lan', 15, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X006', N'Phong Thuận', N'Hàn Quốc', 10, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X008', N'Nhơn Hỏa', N'Nhật Bản', 20, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X010', N'Phượng Hoàng', N'LB Đức', 9, 5)

SET DATEFORMAT DMY

INSERT INTO XETAI (MAXE, MALX, NGMUA, SOKM) VALUES('M001', 'X010', '20/1/2017', 1500)
INSERT INTO XETAI (MAXE, MALX, NGMUA, SOKM) VALUES('M003', 'X008', '22/7/2019', 1743)
INSERT INTO XETAI (MAXE, MALX, NGMUA, SOKM) VALUES('M005', 'X006', '26/3/2018', 9745)
INSERT INTO XETAI (MAXE, MALX, NGMUA, SOKM) VALUES('M007', 'X004', '21/8/2017', 4577)
INSERT INTO XETAI (MAXE, MALX, NGMUA, SOKM) VALUES('M009', 'X002', '25/9/2016', 9632)

SET DATEFORMAT DMY

INSERT INTO TAIXE(MATX, HOTEN, GTINH, NGAYVL) VALUES('T001', N'Phạm Văn Hai', N'Nam', '15/10/2019')
INSERT INTO TAIXE(MATX, HOTEN, GTINH, NGAYVL) VALUES('T002', N'Nguyễn Văn Thanh', N'Nam', '18/12/2020')
INSERT INTO TAIXE(MATX, HOTEN, GTINH, NGAYVL) VALUES('T003', N'Lê Hồng Phát', N'Nữ', '25/7/2018')
INSERT INTO TAIXE(MATX, HOTEN, GTINH, NGAYVL) VALUES('T004', N'Nguyễn Ngọc Tâm', N'Nam', '5/3/2017')
INSERT INTO TAIXE(MATX, HOTEN, GTINH, NGAYVL) VALUES('T005', N'Trần Văn Tân', N'Nữ', '1/6/2021')
SET DATEFORMAT DMY

INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V001', 'T001', 'M001', 9, 100, '7/12/2021')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V002', 'T004', 'M003', 9, 100, '7/12/2020')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V003', 'T001', 'M005', 9, 100, '7/12/2020')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V004', 'T003', 'M007', 9, 100, '7/12/2021')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V005', 'T005', 'M009', 9, 100, '7/12/2020')

INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V006', 'T001', 'M001', 9, 100, '7/12/2019')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V007', 'T005', 'M005', 9, 100, '7/12/2020')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V008', 'T003', 'M009', 9, 100, '7/12/2021')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V009', 'T002', 'M003', 9, 100, '7/12/2022')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V010', 'T001', 'M007', 9, 100, '7/12/2021')

SET DATEFORMAT DMY
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B001', 'T001', '10/11/2015', 'D1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B002', 'T002', '24/12/2014', 'C1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B003', 'T003', '17/10/2016', 'D1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B004', 'T004', '26/11/2018', 'E1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B005', 'T005', '29/12/2017', 'D3')

--Câu 5: Liệt kê thông tin (MAXE, TENLX, NHASX, NIENHAN) chiếc xe mua năm 2017
--BẢNG: XETAI, LOAIXE
--PHƯƠNG PHÁP KẾT
SELECT MAXE, TENLX, NHASX, NIENHAN
FROM XETAI, LOAIXE
WHERE XETAI.MALX = LOAIXE.MALX AND YEAR(NGMUA) > 2016 AND YEAR (NGMUA) <2018
--Câu 6: Liệt kê tài xết (MATX, TENTX) có bằng loại D1 cấp trong năm 2015, 2016
--BẢNG: TAIXE, BANGLAI
SELECT TAIXE.MATX, HOTEN
FROM TAIXE, BANGLAI
WHERE TAIXE.MATX = BANGLAI.MATX AND LOAI = 'D1' AND YEAR (NGCAP) = '2015'
UNION
SELECT TAIXE.MATX, HOTEN
FROM TAIXE, BANGLAI
WHERE TAIXE.MATX = BANGLAI.MATX AND LOAI = 'D1' AND YEAR (NGCAP) = '2016'
--Câu 7: Tìm xe (MAXE) có tổng quãng đường vận chuyển lớn nhất
--BẢNG: VANCHUYEN
--PHƯƠNG PHÁP: GROUP BY
SELECT MAXE
FROM VANCHUYEN
GROUP BY MAXE
HAVING SUM (QDUONG) >= ALL(SELECT SUM(QDUONG)
						FROM VANCHUYEN
						GROUP BY MAXE)
--Câu 8: Tìm tài xế (MATX, TENTX) lái được tất các các loại xe
--BẢNG: TAIXE, VANCHUYEN, XETAI, LOAIXE
--Phương pháp Chia
SELECT MATX, HOTEN
FROM TAIXE TX
WHERE NOT EXISTS (
	SELECT *
	FROM LOAIXE LX
	WHERE NOT EXISTS (
		SELECT *
		FROM VANCHUYEN VC, XETAI XT
		WHERE VC.MAXE = XT.MAXE AND XT.MALX = LX.MALX AND VC.MATX = TX.MATX
		)
)
--Câu 9: Ràng buộc ngày vận chuyển sau ngày mua xe
--BẢNG: VANCHUYEN
--INSERT, UPDATE
CREATE TRIGGER tr_VC
ON VANCHUYEN
FOR INSERT, UPDATE
AS
	BEGIN
	DECLARE @NGVC smalldatetime, @MAXE CHAR(10), @NGMUA smalldatetime
	SELECT @NGVC = NGVC, @MAXE = MAXE FROM inserted
	SELECT @NGMUA = NGMUA FROM XETAI WHERE @MAXE = MAXE
	IF (@NGVC < @NGMUA)
	BEGIN
	PRINT N'ĐÃ CÓ LỖI. NGÀY VẬN CHUYỂN SAU NGÀY MUA XE'
	ROLLBACK TRAN
	END
	PRINT N'THÊM THÀNH CÔNG'
	END
--Câu 10: Ràng buộc thời gian KLUONG không qua tải trọng 50% xe
--BẢNG: VANCHUYEN
--INSERT, UPDATE
CREATE TRIGGER tr_VC_KHLUONG
ON VANCHUYEN
FOR INSERT, UPDATE
AS
	BEGIN
	DECLARE @KLUONG int, @MAXE char(10), @TAITRONG int
	SELECT @KLUONG = KLUONG, @MAXE = MAXE FROM inserted

	SELECT @TAITRONG = TAITRONG FROM LOAIXE WHERE @MAXE = MALX
	IF (@NGVC < @NGMUA)
	BEGIN
	PRINT N'ĐÃ CÓ LỖI. KLUONG không qua tải trọng 50% xe '
	ROLLBACK TRAN
	END
	PRINT N'THÊM THÀNH CÔNG'
	END